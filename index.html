<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é›»å½±ç›¸ä¼¼åº¦æ¨è–¦ Demo</title>

<style>
  :root { --muted:#666; --border:#e5e7eb; }
  body { font-family: system-ui,-apple-system,"PingFang TC",Segoe UI,Arial; margin: 2rem; }
  h1 { margin: 0 0 .75rem; }
  .bar { display:flex; gap:.5rem; margin:.5rem 0 0; }
  input { flex:1; padding:.6rem .8rem; font-size:16px; border:1px solid var(--border); border-radius:10px; }
  button { padding:.6rem 1rem; font-size:16px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:#fff; }
  #status { margin:.5rem 0; color: var(--muted); }
  .hint { color: var(--muted); font-size: 14px; margin:.25rem 0 .75rem; }
  .card { border:1px solid var(--border); border-radius:12px; padding:1rem; margin:.6rem 0; box-shadow:0 2px 6px rgba(0,0,0,.04); }
  .muted { color: var(--muted); }
  ul.suggest { margin:.5rem 0; padding-left:1.2rem; }
  ul.suggest li { cursor:pointer; margin:.2rem 0; }
  .score { color: var(--muted); font-variant-numeric: tabular-nums; }
</style>

<h1>ğŸ¬ é›»å½±ç›¸ä¼¼åº¦æ¨è–¦</h1>
<div class="bar">
  <input id="q" placeholder="è¼¸å…¥é›»å½±åç¨±ï¼Œä¾‹å¦‚ Avatar / Interstellar / The Matrix">
  <button id="go">æœå°‹</button>
</div>
<div id="status">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
<div class="hint">æç¤ºï¼šæ”¯æ´å¤§å°å¯«å¿½ç•¥ã€éƒ¨åˆ†æ¯”å°ï¼›æ‰¾ä¸åˆ°æœƒåˆ—å‡ºå€™é¸ç‰‡åã€‚</div>

<div id="results"></div>

<script>
let MOV = [];      // movies.json çš„é™£åˆ—ï¼Œæ¯ç­†è‡³å°‘å« {id, title, overview}
let SIM = {};      // similar.json çš„ç‰©ä»¶ï¼Œkey=å­—ä¸²åŒ–çš„ idï¼Œvalue= [{title, score}, ...]
let READY = false;

// å·¥å…·ï¼šå®‰å…¨å–å­—ä¸² & å°å¯«
const lower = s => (s || "").toString().trim().toLowerCase();

async function boot(){
  try {
    const [mj, sj] = await Promise.all([
      fetch("movies.json", {cache:"no-store"}),
      fetch("similar.json", {cache:"no-store"})
    ]);
    if(!mj.ok || !sj.ok) throw new Error("JSON è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªå…©å€‹æª”æ¡ˆèˆ‡ index.html åŒå±¤ã€‚");

    MOV = await mj.json();
    SIM = await sj.json();
    READY = true;

    // é™„åŠ æ¯ç­†çš„é™£åˆ—ç´¢å¼•ï¼ˆå¿…è¦æ™‚å¯ç”¨ï¼‰
    MOV.forEach((m, i) => { m.__idx = i; });

    document.getElementById("status").textContent = `âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼š${MOV.length} ç­†`;
    console.log("[DEBUG] MOV length =", MOV.length);
    console.log("[DEBUG] First 5 titles =", MOV.slice(0,5).map(m=>m.title));
  } catch (err) {
    console.error(err);
    document.getElementById("status").textContent = "âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼šè«‹æª¢æŸ¥ movies.json / similar.json è·¯å¾‘èˆ‡å…§å®¹ã€‚";
  }
}

function pickMovieByTitle(query){
  const q = lower(query);
  if(!q) return null;
  // å…ˆæ¨¡ç³ŠåŒ…å«
  const candidates = MOV.filter(m => lower(m.title).includes(q));
  if(candidates.length === 0) return {movie:null, candidates:[]};
  // å„ªå…ˆå®Œå…¨ç›¸ç­‰ï¼ˆå¿½ç•¥å¤§å°å¯«ï¼‰
  const exact = candidates.find(m => lower(m.title) === q);
  return { movie: exact || candidates[0], candidates };
}

function renderSuggestions(list){
  const html = `
    <div class="card">
      <div class="muted" style="margin-bottom:.25rem">å¯èƒ½æƒ³æ‰¾ï¼š</div>
      <ul class="suggest">
        ${list.slice(0,10).map(m => `<li data-title="${m.title.replace(/"/g,'&quot;')}">${m.title}</li>`).join("")}
      </ul>
    </div>`;
  const box = document.getElementById("results");
  box.innerHTML += html;
  // ç¶å®šé»æ“Šï¼šé»å€™é¸ç›´æ¥å¸¶å…¥æœå°‹æ¬„ä¸¦æŸ¥è©¢
  box.querySelectorAll("ul.suggest li").forEach(li=>{
    li.addEventListener("click", ()=>{
      const t = li.getAttribute("data-title");
      document.getElementById("q").value = t;
      search();
    });
  });
}

function search(){
  if(!READY){
    document.getElementById("results").innerHTML = "âŒ› è³‡æ–™é‚„åœ¨è¼‰å…¥ï¼Œè«‹ç¨å€™ã€‚";
    return;
  }
  const input = document.getElementById("q").value;
  const { movie, candidates } = pickMovieByTitle(input);

  if(!movie){
    const firstLetter = lower(input).slice(0,1);
    const fallback = firstLetter
      ? MOV.filter(m => lower(m.title).startsWith(firstLetter)).slice(0,10)
      : MOV.slice(0,10);
    document.getElementById("results").innerHTML =
      `<div class="card">âŒ æ‰¾ä¸åˆ°ï¼š<b>${input || "(ç©ºç™½)"}</b></div>`;
    renderSuggestions(candidates.length ? candidates : fallback);
    return;
  }

  const simKey = String(movie.id); // ğŸ”‘ ç”¨ id å°é½Š similar.json çš„ key
  const sims = Array.isArray(SIM[simKey]) ? SIM[simKey] : [];

  let html = `
    <div class="card">
      <div><b>åŸºæº–é›»å½±ï¼š</b> ${movie.title} <span class="muted">#${movie.id}</span></div>
      ${movie.overview ? `<div class="muted" style="margin-top:.5rem">${movie.overview}</div>` : ""}
    </div>
    <h3>ç›¸ä¼¼é›»å½±</h3>
  `;

  if(sims.length === 0){
    html += `<div class="card">ï¼ˆé€™éƒ¨é›»å½±åœ¨ <code>similar.json</code> æ²’æœ‰ç›¸ä¼¼æ¸…å–®ã€‚è«‹ç¢ºèªè¼¸å‡ºæ™‚ç”¨ <b>id</b> ç•¶ keyï¼Œä¾‹å¦‚ "<code>${movie.id}</code>"ã€‚ï¼‰</div>`;
  } else {
    html += sims.map(s => `
      <div class="card">
        <b>${s.title}</b> <span class="score">score: ${Number(s.score).toFixed(3)}</span>
      </div>
    `).join("");
  }
  document.getElementById("results").innerHTML = html;

  // å¦‚æœä¸€é–‹å§‹å°±æœ‰å¤šå€‹å€™é¸ï¼Œå†é™„ä¸Šå»ºè­°æ¸…å–®æ–¹ä¾¿åˆ‡æ›
  if (candidates && candidates.length > 1) {
    renderSuggestions(candidates);
  }
}

// ç¶å®šäº‹ä»¶
document.getElementById("go").addEventListener("click", search);
document.getElementById("q").addEventListener("keydown", e => { if(e.key === "Enter") search(); });

// å•Ÿå‹•
boot();
</script>
</html>






